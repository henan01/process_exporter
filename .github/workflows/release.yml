name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    name: Build for ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            suffix: linux_amd64
          - os: linux
            arch: arm64
            suffix: linux_arm64
          - os: linux
            arch: arm
            suffix: linux_arm32
            goarm: "7"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.20'

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tag=dev" >> $GITHUB_OUTPUT
          fi

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          if [ -n "${{ matrix.goarm }}" ]; then
            export GOARM="${{ matrix.goarm }}"
          fi
          LDFLAGS="-s -w"
          OUTPUT="process_exporter_${{ matrix.suffix }}"
          go build -ldflags="$LDFLAGS" -o "$OUTPUT" main.go
          chmod +x "$OUTPUT"

      - name: Create checksum
        run: |
          OUTPUT="process_exporter_${{ matrix.suffix }}"
          sha256sum "$OUTPUT" > "$OUTPUT.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: process_exporter_${{ matrix.suffix }}
          path: |
            process_exporter_${{ matrix.suffix }}
            process_exporter_${{ matrix.suffix }}.sha256
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: process_exporter_*
          merge-multiple: false

      - name: Prepare release assets
        run: |
          mkdir -p release
          
          # è°ƒè¯•ï¼šåˆ—å‡º artifacts ç›®å½•ç»“æž„
          echo "=== Artifacts ç›®å½•ç»“æž„ ==="
          find artifacts -type f -o -type d | head -20
          echo ""
          echo "=== æŸ¥æ‰¾ process_exporter æ–‡ä»¶ ==="
          find artifacts -name "process_exporter_*" -type f
          
          # å¤åˆ¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œæ–‡ä»¶
          echo ""
          echo "=== å¤åˆ¶æ–‡ä»¶åˆ° release ç›®å½• ==="
          # æŸ¥æ‰¾å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæŽ’é™¤ .sha256 æ–‡ä»¶ï¼‰
          for file in $(find artifacts -type f -name "process_exporter_*" ! -name "*.sha256"); do
            echo "å¤åˆ¶: $file"
            cp -v "$file" release/
          done
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ ¡éªŒå’Œæ–‡ä»¶
          for file in $(find artifacts -type f -name "*.sha256"); do
            echo "å¤åˆ¶æ ¡éªŒå’Œ: $file"
            cp -v "$file" release/
          done
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo ""
          echo "=== Release ç›®å½•å†…å®¹ ==="
          ls -lh release/ || echo "Release ç›®å½•ä¸ºç©ºï¼"
          
          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find release -type f 2>/dev/null | wc -l)
          echo ""
          echo "æ‰¾åˆ° $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°è¦å‘å¸ƒçš„æ–‡ä»¶ï¼"
            echo "Artifacts ç›®å½•å†…å®¹:"
            find artifacts -type f || true
            exit 1
          fi
          
          # åˆ—å‡ºæ‰€æœ‰è¦å‘å¸ƒçš„æ–‡ä»¶
          echo ""
          echo "=== è¦å‘å¸ƒçš„æ–‡ä»¶åˆ—è¡¨ ==="
          find release -type f -exec echo {} \;
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
          cat > release/README.txt <<EOF
          Process Exporter Release ${{ steps.get_version.outputs.version }}
          
          æ–‡ä»¶è¯´æ˜Žï¼š
          - process_exporter_linux_amd64    : Linux AMD64 (x86_64) æž¶æž„
          - process_exporter_linux_arm64    : Linux ARM64 (aarch64) æž¶æž„
          - process_exporter_linux_arm32     : Linux ARM32 (ARMv7) æž¶æž„
          - *.sha256                         : SHA256 æ ¡éªŒå’Œæ–‡ä»¶
          
          ä½¿ç”¨æ–¹æ³•ï¼š
          1. ä¸‹è½½å¯¹åº”æž¶æž„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          2. æ·»åŠ æ‰§è¡Œæƒé™: chmod +x process_exporter_linux_*
          3. è¿è¡Œ: ./process_exporter_linux_* --remote.url=http://victoriametrics:8428/api/v1/write
          
          éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          sha256sum -c process_exporter_linux_*.sha256
          EOF

      - name: List release files
        run: |
          echo "=== å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ ==="
          find release -type f -exec ls -lh {} \;
          echo "=== æ–‡ä»¶è·¯å¾„ ==="
          find release -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Process Exporter ${{ steps.get_version.outputs.version }}
            
            ### ðŸ“¦ ä¸‹è½½
            
            è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿæž¶æž„ä¸‹è½½å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
            
            - **Linux AMD64 (x86_64)**: `process_exporter_linux_amd64`
            - **Linux ARM64 (aarch64)**: `process_exporter_linux_arm64`
            - **Linux ARM32 (ARMv7)**: `process_exporter_linux_arm32`
            
            ### ðŸ” éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
            
            ä¸‹è½½åŽå¯ä»¥ä½¿ç”¨ SHA256 æ ¡éªŒå’ŒéªŒè¯æ–‡ä»¶ï¼š
            
            ```bash
            sha256sum -c process_exporter_linux_amd64.sha256
            ```
            
            ### ðŸš€ å¿«é€Ÿå¼€å§‹
            
            ```bash
            # 1. ä¸‹è½½å¹¶æ·»åŠ æ‰§è¡Œæƒé™
            chmod +x process_exporter_linux_amd64
            
            # 2. è¿è¡Œï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„ VictoriaMetrics æˆ– Prometheus åœ°å€ï¼‰
            ./process_exporter_linux_amd64 \
              --remote.url=http://victoriametrics:8428/api/v1/write \
              --interval=60s \
              --top=10
            ```
            
            ### ðŸ“š æ›´å¤šä¿¡æ¯
            
            è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·æŸ¥çœ‹ [README.md](README.md)
            
            ### ðŸ“ å˜æ›´æ—¥å¿—
            
            æŸ¥çœ‹ [GitHub Releases](https://github.com/${{ github.repository }}/releases) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          files: |
            release/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

